<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kamus Mandarin Pribadi</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="container">
    <h1>Kamus Mandarin Pribadi</h1>
    <p class="muted">Hanzi / Pinyin / Arti. Data berasal dari <code>vocab.json</code> di repo. Tambah, edit, hapus. Simpan ke LocalStorage atau (opsional) ke GitHub.</p>

    <section class="grid">
      <div class="card">
        <div class="controls">
          <input id="filter" placeholder="Cari hanzi, pinyin, arti..." />
          <button id="btnClearFilter" class="btn-ghost small">Clear</button>
        </div>

        <table id="vocabTable">
          <thead>
            <tr><th>Hanzi</th><th>Pinyin</th><th>Arti</th><th style="width:120px">Aksi</th></tr>
          </thead>
          <tbody></tbody>
        </table>

        <h3>Tambah Kosakata</h3>
        <div class="form-grid">
          <input id="newHanzi" placeholder="Hanzi (mis: 我)" />
          <input id="newPinyin" placeholder="Pinyin (mis: wǒ)" />
          <textarea id="newArti" placeholder="Arti (mis: saya)" rows="3"></textarea>
          <div class="row actions">
            <button id="btnAdd" class="btn-primary small">Tambah</button>
            <button id="btnLoadSample" class="btn-ghost small">Isi contoh</button>
          </div>
        </div>

        <p class="note">Klik <em>Edit</em> pada baris untuk ubah (dialog). Simpan ke LocalStorage agar perubahan tersimpan pada browser.</p>
      </div>

      <div class="card">
        <h3>Pengaturan Penyimpanan</h3>
        <p class="muted">Muat dari repo: masukkan raw URL atau owner/repo/path di bawah. Untuk menyimpan otomatis ke GitHub, perlu Personal Access Token (PASTI HATI-HATI — jangan publikasikan token).</p>

        <label class="muted">Raw URL (contoh: https://raw.githubusercontent.com/USERNAME/REPO/main/vocab.json)</label>
        <input id="rawUrl" placeholder="https://raw.githubusercontent.com/..." />

        <label class="muted">Owner / Repo / Path / Branch</label>
        <input id="ghOwner" placeholder="owner (username atau org)" />
        <input id="ghRepo" placeholder="repo (nama repo)" />
        <input id="ghPath" placeholder="path (mis. vocab.json)" />
        <input id="ghBranch" placeholder="branch (default: main)" />
        <textarea id="ghToken" placeholder="Personal access token (opsional untuk menyimpan)"></textarea>

        <div class="row">
          <button id="btnLoad" class="btn-primary small">Muat Data</button>
          <button id="btnSaveGit" class="btn-ghost small">Simpan ke GitHub</button>
          <button id="btnSaveLocal" class="btn-ghost small">Simpan ke Local</button>
        </div>

        <div id="status" class="note">Status: siap</div>

        <hr />
        <h4>Preview / Raw</h4>
        <pre id="rawPreview" class="rawbox"></pre>
      </div>
    </section>
  </main>

  <footer class="footer">Petunjuk: Jika ingin menyimpan ke repo secara otomatis, buat Personal Access Token dengan scope <code>repo</code>. Jangan share token.</footer>

  <script>
    // Data model
    let vocab = [];
    const localKey = 'vocab-local-json';

    // Helpers
    function utf8_to_b64(str){ return btoa(unescape(encodeURIComponent(str))); }
    function b64_to_utf8(b64){ return decodeURIComponent(escape(atob(b64))); }
    function setStatus(msg, isError){ const el = document.getElementById('status'); el.textContent = 'Status: '+msg; el.style.background = isError ? '#ffecec' : '#ecffef'; setTimeout(()=>{el.style.background='transparent'},4000); }

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function renderTable(){
      const tbody = document.querySelector('#vocabTable tbody'); tbody.innerHTML='';
      const q = document.getElementById('filter').value.trim().toLowerCase();
      vocab.forEach((item, idx)=>{
        const matches = !q || [item.hanzi||'', item.pinyin||'', item.arti||''].join(' ').toLowerCase().includes(q);
        const row = document.createElement('tr');
        if(!matches) row.style.display='none';
        row.innerHTML = `
          <td><span class="val-hanzi">${escapeHtml(item.hanzi||'')}</span></td>
          <td><span class="val-pinyin">${escapeHtml(item.pinyin||'')}</span></td>
          <td><span class="val-arti">${escapeHtml(item.arti||'')}</span></td>
          <td>
            <div class="row">
              <button data-idx="${idx}" class="edit small btn-ghost">Edit</button>
              <button data-idx="${idx}" class="del small btn-ghost">Hapus</button>
            </div>
          </td>`;
        tbody.appendChild(row);
      });
      attachRowHandlers();
      document.getElementById('rawPreview').textContent = JSON.stringify(vocab, null, 2);
    }

    function attachRowHandlers(){
      document.querySelectorAll('.del').forEach(btn=>btn.onclick=()=>{
        const i=+btn.dataset.idx; if(!confirm('Hapus kata ini?')) return; vocab.splice(i,1); renderTable(); setStatus('hapus sukses');
      });
      document.querySelectorAll('.edit').forEach(btn=>btn.onclick=()=>{ openEditDialog(+btn.dataset.idx); });
    }

    function openEditDialog(i){
      const item = vocab[i];
      const hanzi = prompt('Hanzi:', item.hanzi||''); if(hanzi===null) return;
      const pinyin = prompt('Pinyin:', item.pinyin||''); if(pinyin===null) return;
      const arti = prompt('Arti:', item.arti||''); if(arti===null) return;
      vocab[i] = {hanzi:hanzi.trim(), pinyin:pinyin.trim(), arti:arti.trim()}; renderTable(); setStatus('edit tersimpan (memori)');
    }

    // CRUD UI
    document.getElementById('btnAdd').onclick = ()=>{
      const h = document.getElementById('newHanzi').value.trim();
      const p = document.getElementById('newPinyin').value.trim();
      const a = document.getElementById('newArti').value.trim();
      if(!h){ alert('Hanzi tidak boleh kosong'); return; }
      vocab.push({hanzi:h,pinyin:p,arti:a});
      document.getElementById('newHanzi').value=''; document.getElementById('newPinyin').value=''; document.getElementById('newArti').value='';
      renderTable(); setStatus('kata ditambahkan (memori)');
    };
    document.getElementById('btnLoadSample').onclick = ()=>{
      vocab = [
        {hanzi:'我',pinyin:'wǒ',arti:'saya'},
        {hanzi:'你',pinyin:'nǐ',arti:'kamu'},
        {hanzi:'好',pinyin:'hǎo',arti:'baik'},
        {hanzi:'谢谢',pinyin:'xièxie',arti:'terima kasih'},
      ]; renderTable(); setStatus('sample dimuat');
    };
    document.getElementById('filter').oninput = renderTable;
    document.getElementById('btnClearFilter').onclick = ()=>{ document.getElementById('filter').value=''; renderTable(); }

    // Load/Save
    async function loadFromRawUrl(url){
      setStatus('memuat dari raw URL...');
      const r = await fetch(url);
      if(!r.ok) throw new Error('Failed to load raw URL: '+r.status);
      const txt = await r.text(); vocab = JSON.parse(txt); renderTable(); setStatus('dimuat dari raw URL');
    }

    async function loadFromGitHubAPI(owner, repo, path, branch, token){
      setStatus('memuat dari GitHub API...');
      const api = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}${branch?('?ref='+encodeURIComponent(branch)):''}`;
      const r = await fetch(api, {headers: token?{Authorization:'token '+token, Accept:'application/vnd.github.v3.raw'}:{Accept:'application/vnd.github.v3.raw'}});
      if(!r.ok) throw new Error('GitHub API fetch failed: '+r.status);
      const txt = await r.text(); vocab = JSON.parse(txt); renderTable(); setStatus('dimuat dari GitHub API');
    }

    async function saveToGitHub(owner, repo, path, branch, token){
      if(!token) throw new Error('Token dibutuhkan untuk menyimpan ke GitHub');
      setStatus('mempersiapkan commit...');
      const getApi = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}${branch?('?ref='+encodeURIComponent(branch)):''}`;
      const head = await fetch(getApi, {headers:{Authorization:'token '+token}});
      let sha = null;
      if(head.ok){ const meta = await head.json(); sha = meta.sha; }
      const body = {
        message: `Update vocab.json via web editor @ ${new Date().toISOString()}`,
        content: utf8_to_b64(JSON.stringify(vocab, null, 2)),
      };
      if(branch) body.branch = branch;
      if(sha) body.sha = sha;
      const put = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, {method:'PUT', headers:{Authorization:'token '+token, 'Content-Type':'application/json'}, body: JSON.stringify(body)});
      if(!put.ok){ const txt = await put.text(); throw new Error('GitHub PUT failed: '+put.status+'\\n'+txt); }
      setStatus('tersimpan ke GitHub');
    }

    function saveToLocal(){ localStorage.setItem(localKey, JSON.stringify(vocab)); setStatus('tersimpan ke LocalStorage'); }
    function loadFromLocal(){ const s=localStorage.getItem(localKey); if(!s) throw new Error('tidak ada data local'); vocab = JSON.parse(s); renderTable(); setStatus('dimuat dari LocalStorage'); }

    // Buttons
    document.getElementById('btnLoad').onclick = async ()=>{
      try{
        const raw = document.getElementById('rawUrl').value.trim();
        if(raw){ await loadFromRawUrl(raw); return; }
        const owner=document.getElementById('ghOwner').value.trim();
        const repo=document.getElementById('ghRepo').value.trim();
        const path=document.getElementById('ghPath').value.trim();
        const branch=document.getElementById('ghBranch').value.trim();
        const token=document.getElementById('ghToken').value.trim();
        if(owner && repo && path){ await loadFromGitHubAPI(owner, repo, path, branch, token||null); return; }
        await loadFromLocal();
      }catch(e){ setStatus('error: '+e.message, true); console.error(e); alert('Gagal memuat: '+e.message); }
    };

    document.getElementById('btnSaveGit').onclick = async ()=>{
      try{
        const owner=document.getElementById('ghOwner').value.trim();
        const repo=document.getElementById('ghRepo').value.trim();
        const path=document.getElementById('ghPath').value.trim();
        const branch=document.getElementById('ghBranch').value.trim();
        const token=document.getElementById('ghToken').value.trim();
        if(!owner || !repo || !path){ alert('Isi owner, repo, dan path untuk menyimpan ke GitHub'); return; }
        await saveToGitHub(owner, repo, path, branch||'main', token);
      }catch(e){ setStatus('error saat simpan: '+e.message, true); console.error(e); alert('Gagal simpan ke GitHub: '+e.message); }
    };

    document.getElementById('btnSaveLocal').onclick = ()=>{ saveToLocal(); };

    // Init: try load local else empty
    (function(){
      const s = localStorage.getItem(localKey);
      if(s){ try{ vocab = JSON.parse(s); renderTable(); setStatus('data local ditemukan'); return; }catch(_){} }
      vocab = [];
      renderTable();
    })();

    // Ctrl/Cmd+S shortcut to save local
    window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key==='s'){ e.preventDefault(); saveToLocal(); } });
  </script>
</body>
</html>
